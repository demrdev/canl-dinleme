<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0ea5e9">
    <meta name="description" content="Kalp atƒ±≈üƒ± dinleme (eƒüitsel) ‚Äî mobil cihazlar i√ßin sade aray√ºz.">
    <title>Kalp Dinleme (Eƒüitsel)</title>
    <link rel="manifest" href="manifest.json">
    <script src="heartbeat-demo.js"></script>
    <style>
        :root {
            --bg1: #0ea5e9; /* cyan-500 */
            --bg2: #2563eb; /* blue-600 */
            --card: rgba(255, 255, 255, 0.98);
            --text: #0f172a;
            --muted: #64748b;
            --accent: #10b981; /* green-500 */
            --danger: #ef4444;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            margin: 0; padding: 12px; font-family: -apple-system, BlinkMacSystemFont, 'SF Pro', Roboto, system-ui;
            background: linear-gradient(135deg, var(--bg1), var(--bg2)); min-height: 100vh;
        }
        .container { max-width: 640px; margin: 0 auto; background: var(--card); border-radius: 20px; padding: 18px; box-shadow: 0 16px 48px rgba(0,0,0,.25); }
        h1 { margin: 0 0 6px; font-size: 22px; display: flex; align-items: center; gap: 8px; color: var(--text); }
        .subtitle { color: var(--muted); font-size: 13px; margin-bottom: 14px; }
        .badge { display:inline-block; background: var(--danger); color:#fff; font-size:11px; border-radius:6px; padding:2px 6px; margin-left:6px; }
        .cta { background: linear-gradient(135deg, #22c55e, #16a34a); color:#fff; width:100%; border:0; border-radius:12px; padding:14px; font-size:16px; font-weight:700; box-shadow: 0 10px 20px rgba(22,163,74,.25); }
        .cta:active { transform: scale(.98); }
        .row { display:flex; gap:10px; }
        .btn { flex:1; border:0; border-radius:10px; padding:12px; color:#fff; font-weight:700; }
        .btn.stop { background: var(--danger); }
        .btn.mute { background: #f59e0b; }
        .panel { background:#f8fafc; border-radius:14px; padding:14px; margin-top:14px; }
        .label { font-size:14px; color:#334155; font-weight:600; }
        .value { font-weight:800; color:#0ea5e9; }
        .slider { width:100%; appearance:none; height: 32px; background:transparent; }
        .slider::-webkit-slider-track { height:8px; background:#e2e8f0; border-radius:6px; }
        .slider::-webkit-slider-thumb { -webkit-appearance:none; appearance:none; width:26px; height:26px; background:#0ea5e9; border-radius:50%; margin-top:-9px; box-shadow:0 2px 6px rgba(14,165,233,.4); }
        .status { padding:12px; text-align:center; border-radius:10px; margin-top:12px; font-weight:600; font-size:14px; }
        .status.idle { background:#e2e8f0; color:#475569; }
        .status.live { background:#dcfce7; color:#14532d; }
        .warn { background: linear-gradient(135deg, #ef4444, #b91c1c); color:#fff; border-radius:14px; padding:14px; font-size:13px; }
        canvas { width:100%; height:150px; background:#0f172a; border-radius:10px; display:block; }
        small { color:#64748b; }
        @media (prefers-color-scheme: dark) {
            :root { --card: rgba(15, 23, 42, .96); --text: #e5e7eb; --muted:#94a3b8; }
            body { background: linear-gradient(135deg, #0b162a, #0b1220); }
            .panel { background: rgba(255,255,255,.06); }
            .container { border:1px solid rgba(255,255,255,.08); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚ù§Ô∏è Kalp Dinleme <span id="live" class="badge" style="display:none">CANLI</span></h1>
        <div class="subtitle">Sadece kalp atƒ±≈üƒ± dinleme ve BPM analizi (eƒüitsel)</div>

        <div class="warn" id="demoWarn">
            ‚ö†Ô∏è Bu uygulama yalnƒ±zca eƒüitim ama√ßlƒ±dƒ±r. Tƒ±bbi tanƒ±/izleme i√ßin kullanƒ±lamaz. Geri beslemeyi √∂nlemek i√ßin kulaklƒ±k kullanƒ±n.
        </div>

        <div class="panel">
            <button id="start" class="cta" onclick="start()">üé§ Kalp Dinlemeyi Ba≈ülat</button>
            <div class="row" style="margin-top:10px; gap:10px;">
                <button id="stop" class="btn stop" onclick="stopAll()" disabled>‚èπÔ∏è Durdur</button>
                <button id="mute" class="btn mute" onclick="toggleMute()" disabled>üîá Sessiz</button>
            </div>

            <div class="panel" style="margin-top:12px;">
                <div style="display:flex; align-items:center; justify-content:space-between;">
                    <span class="label">Ses G√º√ßlendirme</span>
                    <span class="value" id="gainLabel">10x</span>
                </div>
                <input id="gain" class="slider" type="range" min="1" max="50" step="1" value="10" oninput="updateGain(this.value)">
            </div>

            <div class="panel" style="margin-top:12px; display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <div style="text-align:center; background:#fff; border-radius:12px; padding:10px;">
                    <div class="label" style="color:#64748b;">BPM</div>
                    <div id="bpm" style="font-size:28px; font-weight:900; color:#10b981;">--</div>
                </div>
                <div style="text-align:center; background:#fff; border-radius:12px; padding:10px;">
                    <div class="label" style="color:#64748b;">G√ºven</div>
                    <div id="conf" style="font-size:28px; font-weight:900; color:#0ea5e9;">0%</div>
                </div>
            </div>

            <div class="panel" style="margin-top:12px;">
                <div class="label" style="margin-bottom:6px;">Dalgaboyu</div>
                <canvas id="wave"></canvas>
            </div>
        </div>

        <div class="status idle" id="status">Hazƒ±r</div>
        <div style="margin-top:10px;">
            <small>ƒ∞pucu: Telefonu karƒ±n b√∂lgesinde yumu≈üak√ßa gezdirin, m√ºmk√ºnse kulaklƒ±k kullanƒ±n.</small>
        </div>
    </div>

    <script>
    let ctx, src, outGain, analyser, stream, raf, muted = false, listening = false;
    let hb, ring, ringIdx = 0, hbTimer = null;
    const ringSeconds = 3; // 3 sn pencere

    function setStatus(t, kind) {
        const s = document.getElementById('status');
        s.textContent = t;
        s.className = 'status ' + (kind || 'idle');
    }

    async function start() {
        try {
            document.getElementById('start').disabled = true;
            setStatus('Mikrofon ba≈ülatƒ±lƒ±yor‚Ä¶', 'idle');
            const AC = window.AudioContext || window.webkitAudioContext;
            ctx = new AC();
            if (ctx.state === 'suspended') await ctx.resume();

            const constraints = { audio: { echoCancellation:false, noiseSuppression:false, autoGainControl:false, channelCount:1, sampleRate:48000 } };
            stream = await navigator.mediaDevices.getUserMedia(constraints);
            src = ctx.createMediaStreamSource(stream);

            // Kalp filtresi ve zincir
            if (!hb) hb = new HeartbeatDetectionDemo();
            let current = hb.createHeartbeatFilter(ctx, src);

            // Kullanƒ±cƒ± kazancƒ±
            outGain = ctx.createGain();
            outGain.gain.value = parseFloat(document.getElementById('gain').value);
            current.connect(outGain);

            // Analiz√∂r
            analyser = ctx.createAnalyser();
            analyser.fftSize = 4096; // daha uzun √∂rnek
            outGain.connect(analyser);

            // √áƒ±kƒ±≈ü (kulaklƒ±k √∂nerilir)
            outGain.connect(ctx.destination);

            // Ring buffer (3 sn)
            ring = new Float32Array(Math.max(1, Math.round((ctx.sampleRate||48000)*ringSeconds)));
            ringIdx = 0;

            listening = true;
            document.getElementById('stop').disabled = false;
            document.getElementById('mute').disabled = false;
            document.getElementById('live').style.display = 'inline-block';
            setStatus('Canlƒ± dinleme aktif', 'live');

            draw();
            startHB();
        } catch (e) {
            console.error(e);
            setStatus('Hata: ' + e.message, 'idle');
            document.getElementById('start').disabled = false;
        }
    }

    function stopAll() {
        listening = false;
        if (raf) cancelAnimationFrame(raf);
        if (hbTimer) { clearInterval(hbTimer); hbTimer = null; }
        if (stream) { stream.getTracks().forEach(t=>t.stop()); stream = null; }
        if (src) { try{src.disconnect();}catch{} src = null; }
        if (outGain) { try{outGain.disconnect();}catch{} outGain = null; }
        if (analyser) { try{analyser.disconnect();}catch{} analyser = null; }
        if (ctx) { try{ctx.close();}catch{} ctx = null; }
        ring = null; ringIdx = 0;
        document.getElementById('stop').disabled = true;
        document.getElementById('mute').disabled = true;
        document.getElementById('start').disabled = false;
        document.getElementById('live').style.display = 'none';
        setStatus('Durduruldu', 'idle');
        // temizle √ßizim
        const canvas = document.getElementById('wave');
        const g = canvas.getContext('2d');
        g.fillStyle = '#0f172a'; g.fillRect(0,0,canvas.width,canvas.height);
    }

    function toggleMute() {
        if (!outGain) return;
        muted = !muted;
        outGain.gain.value = muted ? 0 : parseFloat(document.getElementById('gain').value);
        document.getElementById('mute').textContent = muted ? 'üîä Sesi A√ß' : 'üîá Sessiz';
    }

    function updateGain(v) {
        document.getElementById('gainLabel').textContent = v + 'x';
        if (outGain && !muted) outGain.gain.value = parseFloat(v);
    }

    function draw() {
        if (!analyser) return;
        const canvas = document.getElementById('wave');
        const g = canvas.getContext('2d');
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width; canvas.height = rect.height;

        const n = analyser.frequencyBinCount; // half of fftSize
        const td = new Float32Array(n);
        analyser.getFloatTimeDomainData(td);

        // ring'e yaz
        for (let i=0;i<td.length;i++) {
            ring[ringIdx++] = td[i];
            if (ringIdx >= ring.length) ringIdx = 0;
        }

        g.fillStyle = '#0f172a'; g.fillRect(0,0,canvas.width,canvas.height);
        g.strokeStyle = '#10b981'; g.lineWidth = 2; g.beginPath();
        for (let x=0; x<canvas.width; x++) {
            const idx = Math.floor(x / canvas.width * td.length);
            const y = (0.5 - td[idx] * 0.45) * canvas.height;
            if (x===0) g.moveTo(x,y); else g.lineTo(x,y);
        }
        g.stroke();
        raf = requestAnimationFrame(draw);
    }

    function startHB() {
        if (!hb || !analyser) return;
        hbTimer = setInterval(() => {
            // son 3 sn'yi contiguous diziye al
            const full = new Float32Array(ring.length);
            const right = ring.length - ringIdx;
            full.set(ring.subarray(ringIdx));
            full.set(ring.subarray(0, ringIdx), right);

            const env = hb.envelopeDetection(full);
            const res = hb.detectRhythmicPatterns(env);
            document.getElementById('bpm').textContent = res.bpm || '--';
            document.getElementById('conf').textContent = (res.confidence|0) + '%';
            if (res.bpm >= 120 && res.bpm <= 160) {
                document.getElementById('bpm').style.color = '#10b981';
            } else {
                document.getElementById('bpm').style.color = '#f59e0b';
            }
        }, 300);
    }
    </script>
</body>
</html>
